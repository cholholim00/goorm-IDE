import google.generativeai as genai
import json
import pandas as pd
import re
import time
import sys

# ==========================================
# 1. API í‚¤ ì…ë ¥ (ìƒˆë¡œ ë°›ì€ í‚¤ê°€ ìˆë‹¤ë©´ ê·¸ê±¸ë¡œ!)
# ==========================================
GOOGLE_API_KEY = "AIzaSyCG2HYa10tHOezx9iQ9sVgK5yKIT0pVRKo"
genai.configure(api_key=GOOGLE_API_KEY)

print("--- [ì‹œìŠ¤í…œ ê°€ë™] ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ì„ ìŠ¤ìº”í•©ë‹ˆë‹¤ ---")

# ==========================================
# 2. [í•µì‹¬] ì‘ë™í•˜ëŠ” ëª¨ë¸ ìë™ ë‚šì‹œ (Auto-Discovery)
# ==========================================
def find_working_model():
    # ì‹œë„í•´ë³¼ ëª¨ë“  ëª¨ë¸ ì´ë¦„ ë¦¬ìŠ¤íŠ¸ (ìˆœì„œëŒ€ë¡œ ì°”ëŸ¬ë´…ë‹ˆë‹¤)
    candidates = [
        "gemini-1.5-flash",
        "gemini-1.5-pro",
        "gemini-pro",            # êµ¬í˜•ì´ì§€ë§Œ ê°€ì¥ ì•ˆì •ì 
        "gemini-1.0-pro",
        "gemini-flash-latest",
        "gemini-2.0-flash-exp"
    ]

    for model_name in candidates:
        print(f"ğŸ“¡ ì‹ í˜¸ ë³´ë‚´ëŠ” ì¤‘: {model_name}...", end=" ")
        try:
            model = genai.GenerativeModel(model_name)
            # "ì•ˆë…•"ì´ë¼ê³  ë§ ê±¸ì–´ì„œ ëŒ€ë‹µí•˜ë©´ í•©ê²©
            response = model.generate_content("Hi")
            if response:
                print(f"âœ… [ì—°ê²° ì„±ê³µ!]")
                return model, model_name
        except Exception as e:
            # 404(ëª¨ë¸ì—†ìŒ)ë‚˜ 429(í•œë„ì´ˆê³¼)ë©´ ë‹¤ìŒ ëª¨ë¸ë¡œ ë„˜ì–´ê°
            print(f"âŒ (íŒ¨ìŠ¤)")
            time.sleep(1)

    print("\nğŸš¨ [ì¹˜ëª…ì  ì˜¤ë¥˜] ëª¨ë“  ëª¨ë¸ì´ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. API í‚¤ ë¬¸ì œì¼ í™•ë¥  99%ì…ë‹ˆë‹¤.")
    sys.exit()

# ìë™ìœ¼ë¡œ ì°¾ì€ ëª¨ë¸ì„ 'model' ë³€ìˆ˜ì— ì €ì¥
model, valid_name = find_working_model()
print(f"\nğŸš€ [í™•ì •] '{valid_name}' ëª¨ë¸ë¡œ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤.")

# ==========================================
# 3. ETL ì—”ì§„ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
# ==========================================
def run_medical_etl(raw_text):
    prompt = f"""
    ### ì—­í• : í•œêµ­ì–´ ì˜ë£Œ ë°ì´í„° ë¶„ì„ê°€
    ### ëª©í‘œ: JSON ì¶œë ¥ (ê°’ì€ ë°˜ë“œì‹œ í•œêµ­ì–´)
    
    ### ìŠ¤í‚¤ë§ˆ
    - age: (ì •ìˆ˜/null)
    - gender: (ë‚¨ì„±/ì—¬ì„±/null)
    - symptom: (í•œêµ­ì–´ í‘œì¤€ ì˜í•™ ìš©ì–´)
    - pain_level: (1-10 ì •ìˆ˜/null)
    - duration: (ê¸°ê°„ ë¬¸ìì—´/null)
    
    ### ì…ë ¥: "{raw_text}"
    ### ì œì•½: ì˜¤ì§ JSON ì½”ë“œë§Œ ì¶œë ¥.
    """

    for attempt in range(1, 4):
        try:
            response = model.generate_content(prompt)
            text = response.text.strip()
            clean_json = re.sub(r'```json|```', '', text).strip()
            return json.loads(clean_json)
        except:
            if attempt < 3:
                print(f"   (í†µì‹  ë¶ˆì•ˆì •... {attempt}ì°¨ ì¬ì‹œë„ ì¤‘ â³)", end="\r")
                time.sleep(5)
            else:
                return {"error": "Fail"}

# ==========================================
# 4. ë°ì´í„° 20ê°œ ì‹¤í–‰
# ==========================================
raw_data_batch = [
    "í™˜ì 45ì„¸ ë‚¨ì„±, ì–´ì œë¶€í„° ì˜¤ë¥¸ìª½ ì•„ë«ë°°ê°€ ì°¢ì–´ì§€ê²Œ ì•„í””. í†µì¦ 8ì .",
    "32ì„¸ ì—¬ì„±ì…ë‹ˆë‹¤. ì˜¤ëŠ˜ ì•„ì¹¨ë¶€í„° í¸ë‘í†µì´ ì‹¬í•˜ê³  ì†ì´ ë©”ìŠ¤êº¼ì›Œìš”. í†µì¦ì€ 6ì  ì •ë„?",
    "5ì‚´ ìš°ë¦¬ ì•„ë“¤(ë‚¨ì), 3ì¼ ì „ë¶€í„° ê¸°ì¹¨ì´ ì•ˆ ë©ˆì¶”ê³  ìŒ•ìŒ•ê±°ë ¤ìš”. ì—´ë„ 38.5ë„ë‚˜ ë‚˜ë„¤ìš”.",
    "82ì„¸ í• ì•„ë²„ì§€ì‹ ë°, ì‹ì‚¬ë§Œ í•˜ì‹œë©´ ì†Œí™”ê°€ ì•ˆ ëœë‹¤ê³  í•˜ì‹­ë‹ˆë‹¤.",
    "ì•„ ë°° ì•„íŒŒ ì£½ê² ë„¤ ì§„ì§œ ì•½ ì—†ì–´ìš”?",
    "ë¨¸ë¦¬ê°€ ëµí•œë° ì´ê±° ì™œ ì´ëŸ¬ì£ ?",
    "ëª¸ì‚´ ê¸°ìš´ì´ ì¢€ ìˆëŠ” ê²ƒ ê°™ì€ë°...",
    "ì–´ì œ íšŒì‹ì—ì„œ ìˆ ì„ ì¢€ ë§ì´ ë§ˆì…¨ëŠ”ë°, ì•„ì¹¨ì— í•´ì¥êµ­ ë¨¹ê³  ë‚˜ë‹ˆê¹Œ ì†ì´ ê³„ì† ì“°ë¦¬ë„¤ìš”. 29ì„¸ ë‚¨ìì…ë‹ˆë‹¤.",
    "ì œê°€ ë‚´ì¼ ì—¬í–‰ ê°€ì•¼ í•˜ëŠ”ë° ê°‘ìê¸° ì„¤ì‚¬ë¥¼ í•´ìš”. 20ëŒ€ ì—¬ìêµ¬ìš”.",
    "30ì„¸ ë‚¨, ë°°ê°€ ì•„í”ˆë° ì—´ì€ ì—†ì–´ìš”. êµ¬í† ë„ ì•ˆ í–ˆê³ ìš”.",
    "40ëŒ€ ì£¼ë¶€ì¸ë° ì†ëª©ì´ ì‹œí°ê±°ë ¤ìš”. ì°¸ì„ ë§Œì€ í•œë°(3~4ì ?)",
    "60ì„¸ ë‚¨ì„±, ê°€ìŠ´ì´ ì¥ì–´ì§œëŠ” ë“¯ì´ ì•„íŒŒìš”. í†µì¦ì€ ì§„ì§œ ì£½ì„ ê²ƒ ê°™ì•„ìš”(10ì ).",
    "10ëŒ€ ì—¬í•™ìƒ, ì¼ì£¼ì¼ ì „ë¶€í„° ìƒë¦¬í†µì´ ë„ˆë¬´ ì‹¬í•´ìš”.",
    "55ì„¸ ë‚¨, ë°©ê¸ˆ ì „ë¶€í„° ê°‘ìê¸° ëˆˆì•ì´ ìº„ìº„í•´ì§€ê³  ì–´ì§€ëŸ¬ì›€.",
    "ë‘ ë‹¬ ì •ë„ ëœ ê²ƒ ê°™ì•„ìš”. í—ˆë¦¬ê°€ ê³„ì† ë»ê·¼í•˜ë„¤ìš”. (40ëŒ€/ë‚¨)",
    "70ì„¸ ì—¬ì„±, ë¬´ë¦ë„ ì‘¤ì‹œê³  í—ˆë¦¬ë„ ì•„í”„ê³ ... ë¹„ë§Œ ì˜¤ë©´ ì˜¨ëª¸ì´ ì‘¤ì…”ìš”.",
    "ëª©ë„ ë¶“ê³  ì½§ë¬¼ ë‚˜ê³  ë¨¸ë¦¬ë„ ì•„í”„ê³  ì´ì²´ì  ë‚œêµ­ì…ë‹ˆë‹¤. 20ëŒ€ ì´ˆë°˜ ë‚¨ììš”.",
    "30ëŒ€ ì—¬, ë°œëª© ì ‘ì§ˆë ·ëŠ”ë° í‰í‰ ë¶€ì—‡ìŒ. ë„˜ ì•„íŒŒì—¬ ã… ã… ",
    "ì†ì´ ìš¸ë ê±°ë¦¼. 50ë‚¨. ì–´ì œ ì €ë…ë¶€í„°."
]

processed_data = []

print(f"\n--- [ì‘ì—… ì‹œì‘] {len(raw_data_batch)}ê±´ ì²˜ë¦¬ ---")

for i, text in enumerate(raw_data_batch):
    print(f"[ë°ì´í„° {i+1}] ë¶„ì„ ì¤‘...", end=" ")

    result = run_medical_etl(text)

    if "error" not in result:
        print(f"âœ… {result.get('symptom')}")
        processed_data.append(result)
    else:
        print(f"âš ï¸ ì‹¤íŒ¨")

    # ì•ˆì •ì ì¸ ì†ë„ ìœ ì§€
    time.sleep(3)

# ==========================================
# 5. ì €ì¥
# ==========================================
if processed_data:
    df = pd.DataFrame(processed_data)
    cols = ["age", "gender", "symptom", "pain_level", "duration"]
    valid_cols = [c for c in cols if c in df.columns]

    if valid_cols:
        df = df[valid_cols]
        df_display = df.rename(columns={"age": "ë‚˜ì´", "gender": "ì„±ë³„", "symptom": "ì¦ìƒ", "pain_level": "í†µì¦", "duration": "ê¸°ê°„"})

        print("\n--- [ìµœì¢… ê²°ê³¼] ---")
        display(df_display) if 'display' in globals() else print(df_display)
        df_display.to_csv("ì˜ë£Œ ìƒë‹´ í…ìŠ¤íŠ¸ ë³€í™˜ê²°ê³¼.csv", index=False, encoding="utf-8-sig")
        print("\nğŸ“‚ ì €ì¥ ì™„ë£Œ: ì˜ë£Œ ìƒë‹´ í…ìŠ¤íŠ¸ ë³€í™˜ê²°ê³¼.csv")